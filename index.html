<html lang="vi"><head>
<meta charset="utf-8">
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport">
<title>Test Tr·∫Øc Nghi·ªám Pro</title>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']]
      }
    };
    </script>
<script async="" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script><style type="text/css">.CtxtMenu_InfoClose {  top:.2em; right:.2em;}
.CtxtMenu_InfoContent {  overflow:auto; text-align:left; font-size:80%;  padding:.4em .6em; border:1px inset; margin:1em 0px;  max-height:20em; max-width:30em; background-color:#EEEEEE;  white-space:normal;}
.CtxtMenu_Info.CtxtMenu_MousePost {outline:none;}
.CtxtMenu_Info {  position:fixed; left:50%; width:auto; text-align:center;  border:3px outset; padding:1em 2em; background-color:#DDDDDD;  color:black;  cursor:default; font-family:message-box; font-size:120%;  font-style:normal; text-indent:0; text-transform:none;  line-height:normal; letter-spacing:normal; word-spacing:normal;  word-wrap:normal; white-space:nowrap; float:none; z-index:201;  border-radius: 15px;                     /* Opera 10.5 and IE9 */  -webkit-border-radius:15px;               /* Safari and Chrome */  -moz-border-radius:15px;                  /* Firefox */  -khtml-border-radius:15px;                /* Konqueror */  box-shadow:0px 10px 20px #808080;         /* Opera 10.5 and IE9 */  -webkit-box-shadow:0px 10px 20px #808080; /* Safari 3 & Chrome */  -moz-box-shadow:0px 10px 20px #808080;    /* Forefox 3.5 */  -khtml-box-shadow:0px 10px 20px #808080;  /* Konqueror */  filter:progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color="gray", Positive="true"); /* IE */}
</style><style type="text/css">.CtxtMenu_MenuClose {  position:absolute;  cursor:pointer;  display:inline-block;  border:2px solid #AAA;  border-radius:18px;  -webkit-border-radius: 18px;             /* Safari and Chrome */  -moz-border-radius: 18px;                /* Firefox */  -khtml-border-radius: 18px;              /* Konqueror */  font-family: "Courier New", Courier;  font-size:24px;  color:#F0F0F0}
.CtxtMenu_MenuClose span {  display:block; background-color:#AAA; border:1.5px solid;  border-radius:18px;  -webkit-border-radius: 18px;             /* Safari and Chrome */  -moz-border-radius: 18px;                /* Firefox */  -khtml-border-radius: 18px;              /* Konqueror */  line-height:0;  padding:8px 0 6px     /* may need to be browser-specific */}
.CtxtMenu_MenuClose:hover {  color:white!important;  border:2px solid #CCC!important}
.CtxtMenu_MenuClose:hover span {  background-color:#CCC!important}
.CtxtMenu_MenuClose:hover:focus {  outline:none}
</style><style type="text/css">.CtxtMenu_Menu {  position:absolute;  background-color:white;  color:black;  width:auto; padding:5px 0px;  border:1px solid #CCCCCC; margin:0; cursor:default;  font: menu; text-align:left; text-indent:0; text-transform:none;  line-height:normal; letter-spacing:normal; word-spacing:normal;  word-wrap:normal; white-space:nowrap; float:none; z-index:201;  border-radius: 5px;                     /* Opera 10.5 and IE9 */  -webkit-border-radius: 5px;             /* Safari and Chrome */  -moz-border-radius: 5px;                /* Firefox */  -khtml-border-radius: 5px;              /* Konqueror */  box-shadow:0px 10px 20px #808080;         /* Opera 10.5 and IE9 */  -webkit-box-shadow:0px 10px 20px #808080; /* Safari 3 & Chrome */  -moz-box-shadow:0px 10px 20px #808080;    /* Forefox 3.5 */  -khtml-box-shadow:0px 10px 20px #808080;  /* Konqueror */}
.CtxtMenu_MenuItem {  padding: 1px 2em;  background:transparent;}
.CtxtMenu_MenuArrow {  position:absolute; right:.5em; padding-top:.25em; color:#666666;  font-family: null; font-size: .75em}
.CtxtMenu_MenuActive .CtxtMenu_MenuArrow {color:white}
.CtxtMenu_MenuArrow.CtxtMenu_RTL {left:.5em; right:auto}
.CtxtMenu_MenuCheck {  position:absolute; left:.7em;  font-family: null}
.CtxtMenu_MenuCheck.CtxtMenu_RTL { right:.7em; left:auto }
.CtxtMenu_MenuRadioCheck {  position:absolute; left: .7em;}
.CtxtMenu_MenuRadioCheck.CtxtMenu_RTL {  right: .7em; left:auto}
.CtxtMenu_MenuInputBox {  padding-left: 1em; right:.5em; color:#666666;  font-family: null;}
.CtxtMenu_MenuInputBox.CtxtMenu_RTL {  left: .1em;}
.CtxtMenu_MenuComboBox {  left:.1em; padding-bottom:.5em;}
.CtxtMenu_MenuSlider {  left: .1em;}
.CtxtMenu_SliderValue {  position:absolute; right:.1em; padding-top:.25em; color:#333333;  font-size: .75em}
.CtxtMenu_SliderBar {  outline: none; background: #d3d3d3}
.CtxtMenu_MenuLabel {  padding: 1px 2em 3px 1.33em;  font-style:italic}
.CtxtMenu_MenuRule {  border-top: 1px solid #DDDDDD;  margin: 4px 3px;}
.CtxtMenu_MenuDisabled {  color:GrayText}
.CtxtMenu_MenuActive {  background-color: #606872;  color: white;}
.CtxtMenu_MenuDisabled:focus {  background-color: #E8E8E8}
.CtxtMenu_MenuLabel:focus {  background-color: #E8E8E8}
.CtxtMenu_ContextMenu:focus {  outline:none}
.CtxtMenu_ContextMenu .CtxtMenu_MenuItem:focus {  outline:none}
.CtxtMenu_SelectionMenu {  position:relative; float:left;  border-bottom: none; -webkit-box-shadow:none; -webkit-border-radius:0px; }
.CtxtMenu_SelectionItem {  padding-right: 1em;}
.CtxtMenu_Selection {  right: 40%; width:50%; }
.CtxtMenu_SelectionBox {  padding: 0em; max-height:20em; max-width: none;  background-color:#FFFFFF;}
.CtxtMenu_SelectionDivider {  clear: both; border-top: 2px solid #000000;}
.CtxtMenu_Menu .CtxtMenu_MenuClose {  top:-10px; left:-10px}
</style><style type="text/css">.CtxtMenu_InfoClose {  top:.2em; right:.2em;}
.CtxtMenu_InfoContent {  overflow:auto; text-align:left; font-size:80%;  padding:.4em .6em; border:1px inset; margin:1em 0px;  max-height:20em; max-width:30em; background-color:#EEEEEE;  white-space:normal;}
.CtxtMenu_Info.CtxtMenu_MousePost {outline:none;}
.CtxtMenu_Info {  position:fixed; left:50%; width:auto; text-align:center;  border:3px outset; padding:1em 2em; background-color:#DDDDDD;  color:black;  cursor:default; font-family:message-box; font-size:120%;  font-style:normal; text-indent:0; text-transform:none;  line-height:normal; letter-spacing:normal; word-spacing:normal;  word-wrap:normal; white-space:nowrap; float:none; z-index:201;  border-radius: 15px;                     /* Opera 10.5 and IE9 */  -webkit-border-radius:15px;               /* Safari and Chrome */  -moz-border-radius:15px;                  /* Firefox */  -khtml-border-radius:15px;                /* Konqueror */  box-shadow:0px 10px 20px #808080;         /* Opera 10.5 and IE9 */  -webkit-box-shadow:0px 10px 20px #808080; /* Safari 3 & Chrome */  -moz-box-shadow:0px 10px 20px #808080;    /* Forefox 3.5 */  -khtml-box-shadow:0px 10px 20px #808080;  /* Konqueror */  filter:progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color="gray", Positive="true"); /* IE */}
</style><style type="text/css">.CtxtMenu_MenuClose {  position:absolute;  cursor:pointer;  display:inline-block;  border:2px solid #AAA;  border-radius:18px;  -webkit-border-radius: 18px;             /* Safari and Chrome */  -moz-border-radius: 18px;                /* Firefox */  -khtml-border-radius: 18px;              /* Konqueror */  font-family: "Courier New", Courier;  font-size:24px;  color:#F0F0F0}
.CtxtMenu_MenuClose span {  display:block; background-color:#AAA; border:1.5px solid;  border-radius:18px;  -webkit-border-radius: 18px;             /* Safari and Chrome */  -moz-border-radius: 18px;                /* Firefox */  -khtml-border-radius: 18px;              /* Konqueror */  line-height:0;  padding:8px 0 6px     /* may need to be browser-specific */}
.CtxtMenu_MenuClose:hover {  color:white!important;  border:2px solid #CCC!important}
.CtxtMenu_MenuClose:hover span {  background-color:#CCC!important}
.CtxtMenu_MenuClose:hover:focus {  outline:none}
</style><style type="text/css">.CtxtMenu_Menu {  position:absolute;  background-color:white;  color:black;  width:auto; padding:5px 0px;  border:1px solid #CCCCCC; margin:0; cursor:default;  font: menu; text-align:left; text-indent:0; text-transform:none;  line-height:normal; letter-spacing:normal; word-spacing:normal;  word-wrap:normal; white-space:nowrap; float:none; z-index:201;  border-radius: 5px;                     /* Opera 10.5 and IE9 */  -webkit-border-radius: 5px;             /* Safari and Chrome */  -moz-border-radius: 5px;                /* Firefox */  -khtml-border-radius: 5px;              /* Konqueror */  box-shadow:0px 10px 20px #808080;         /* Opera 10.5 and IE9 */  -webkit-box-shadow:0px 10px 20px #808080; /* Safari 3 & Chrome */  -moz-box-shadow:0px 10px 20px #808080;    /* Forefox 3.5 */  -khtml-box-shadow:0px 10px 20px #808080;  /* Konqueror */}
.CtxtMenu_MenuItem {  padding: 1px 2em;  background:transparent;}
.CtxtMenu_MenuArrow {  position:absolute; right:.5em; padding-top:.25em; color:#666666;  font-family: null; font-size: .75em}
.CtxtMenu_MenuActive .CtxtMenu_MenuArrow {color:white}
.CtxtMenu_MenuArrow.CtxtMenu_RTL {left:.5em; right:auto}
.CtxtMenu_MenuCheck {  position:absolute; left:.7em;  font-family: null}
.CtxtMenu_MenuCheck.CtxtMenu_RTL { right:.7em; left:auto }
.CtxtMenu_MenuRadioCheck {  position:absolute; left: .7em;}
.CtxtMenu_MenuRadioCheck.CtxtMenu_RTL {  right: .7em; left:auto}
.CtxtMenu_MenuInputBox {  padding-left: 1em; right:.5em; color:#666666;  font-family: null;}
.CtxtMenu_MenuInputBox.CtxtMenu_RTL {  left: .1em;}
.CtxtMenu_MenuComboBox {  left:.1em; padding-bottom:.5em;}
.CtxtMenu_MenuSlider {  left: .1em;}
.CtxtMenu_SliderValue {  position:absolute; right:.1em; padding-top:.25em; color:#333333;  font-size: .75em}
.CtxtMenu_SliderBar {  outline: none; background: #d3d3d3}
.CtxtMenu_MenuLabel {  padding: 1px 2em 3px 1.33em;  font-style:italic}
.CtxtMenu_MenuRule {  border-top: 1px solid #DDDDDD;  margin: 4px 3px;}
.CtxtMenu_MenuDisabled {  color:GrayText}
.CtxtMenu_MenuActive {  background-color: #606872;  color: white;}
.CtxtMenu_MenuDisabled:focus {  background-color: #E8E8E8}
.CtxtMenu_MenuLabel:focus {  background-color: #E8E8E8}
.CtxtMenu_ContextMenu:focus {  outline:none}
.CtxtMenu_ContextMenu .CtxtMenu_MenuItem:focus {  outline:none}
.CtxtMenu_SelectionMenu {  position:relative; float:left;  border-bottom: none; -webkit-box-shadow:none; -webkit-border-radius:0px; }
.CtxtMenu_SelectionItem {  padding-right: 1em;}
.CtxtMenu_Selection {  right: 40%; width:50%; }
.CtxtMenu_SelectionBox {  padding: 0em; max-height:20em; max-width: none;  background-color:#FFFFFF;}
.CtxtMenu_SelectionDivider {  clear: both; border-top: 2px solid #000000;}
.CtxtMenu_Menu .CtxtMenu_MenuClose {  top:-10px; left:-10px}
</style><style type="text/css">.CtxtMenu_InfoClose {  top:.2em; right:.2em;}
.CtxtMenu_InfoContent {  overflow:auto; text-align:left; font-size:80%;  padding:.4em .6em; border:1px inset; margin:1em 0px;  max-height:20em; max-width:30em; background-color:#EEEEEE;  white-space:normal;}
.CtxtMenu_Info.CtxtMenu_MousePost {outline:none;}
.CtxtMenu_Info {  position:fixed; left:50%; width:auto; text-align:center;  border:3px outset; padding:1em 2em; background-color:#DDDDDD;  color:black;  cursor:default; font-family:message-box; font-size:120%;  font-style:normal; text-indent:0; text-transform:none;  line-height:normal; letter-spacing:normal; word-spacing:normal;  word-wrap:normal; white-space:nowrap; float:none; z-index:201;  border-radius: 15px;                     /* Opera 10.5 and IE9 */  -webkit-border-radius:15px;               /* Safari and Chrome */  -moz-border-radius:15px;                  /* Firefox */  -khtml-border-radius:15px;                /* Konqueror */  box-shadow:0px 10px 20px #808080;         /* Opera 10.5 and IE9 */  -webkit-box-shadow:0px 10px 20px #808080; /* Safari 3 & Chrome */  -moz-box-shadow:0px 10px 20px #808080;    /* Forefox 3.5 */  -khtml-box-shadow:0px 10px 20px #808080;  /* Konqueror */  filter:progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color="gray", Positive="true"); /* IE */}
</style><style type="text/css">.CtxtMenu_MenuClose {  position:absolute;  cursor:pointer;  display:inline-block;  border:2px solid #AAA;  border-radius:18px;  -webkit-border-radius: 18px;             /* Safari and Chrome */  -moz-border-radius: 18px;                /* Firefox */  -khtml-border-radius: 18px;              /* Konqueror */  font-family: "Courier New", Courier;  font-size:24px;  color:#F0F0F0}
.CtxtMenu_MenuClose span {  display:block; background-color:#AAA; border:1.5px solid;  border-radius:18px;  -webkit-border-radius: 18px;             /* Safari and Chrome */  -moz-border-radius: 18px;                /* Firefox */  -khtml-border-radius: 18px;              /* Konqueror */  line-height:0;  padding:8px 0 6px     /* may need to be browser-specific */}
.CtxtMenu_MenuClose:hover {  color:white!important;  border:2px solid #CCC!important}
.CtxtMenu_MenuClose:hover span {  background-color:#CCC!important}
.CtxtMenu_MenuClose:hover:focus {  outline:none}
</style><style type="text/css">.CtxtMenu_Menu {  position:absolute;  background-color:white;  color:black;  width:auto; padding:5px 0px;  border:1px solid #CCCCCC; margin:0; cursor:default;  font: menu; text-align:left; text-indent:0; text-transform:none;  line-height:normal; letter-spacing:normal; word-spacing:normal;  word-wrap:normal; white-space:nowrap; float:none; z-index:201;  border-radius: 5px;                     /* Opera 10.5 and IE9 */  -webkit-border-radius: 5px;             /* Safari and Chrome */  -moz-border-radius: 5px;                /* Firefox */  -khtml-border-radius: 5px;              /* Konqueror */  box-shadow:0px 10px 20px #808080;         /* Opera 10.5 and IE9 */  -webkit-box-shadow:0px 10px 20px #808080; /* Safari 3 & Chrome */  -moz-box-shadow:0px 10px 20px #808080;    /* Forefox 3.5 */  -khtml-box-shadow:0px 10px 20px #808080;  /* Konqueror */}
.CtxtMenu_MenuItem {  padding: 1px 2em;  background:transparent;}
.CtxtMenu_MenuArrow {  position:absolute; right:.5em; padding-top:.25em; color:#666666;  font-family: null; font-size: .75em}
.CtxtMenu_MenuActive .CtxtMenu_MenuArrow {color:white}
.CtxtMenu_MenuArrow.CtxtMenu_RTL {left:.5em; right:auto}
.CtxtMenu_MenuCheck {  position:absolute; left:.7em;  font-family: null}
.CtxtMenu_MenuCheck.CtxtMenu_RTL { right:.7em; left:auto }
.CtxtMenu_MenuRadioCheck {  position:absolute; left: .7em;}
.CtxtMenu_MenuRadioCheck.CtxtMenu_RTL {  right: .7em; left:auto}
.CtxtMenu_MenuInputBox {  padding-left: 1em; right:.5em; color:#666666;  font-family: null;}
.CtxtMenu_MenuInputBox.CtxtMenu_RTL {  left: .1em;}
.CtxtMenu_MenuComboBox {  left:.1em; padding-bottom:.5em;}
.CtxtMenu_MenuSlider {  left: .1em;}
.CtxtMenu_SliderValue {  position:absolute; right:.1em; padding-top:.25em; color:#333333;  font-size: .75em}
.CtxtMenu_SliderBar {  outline: none; background: #d3d3d3}
.CtxtMenu_MenuLabel {  padding: 1px 2em 3px 1.33em;  font-style:italic}
.CtxtMenu_MenuRule {  border-top: 1px solid #DDDDDD;  margin: 4px 3px;}
.CtxtMenu_MenuDisabled {  color:GrayText}
.CtxtMenu_MenuActive {  background-color: #606872;  color: white;}
.CtxtMenu_MenuDisabled:focus {  background-color: #E8E8E8}
.CtxtMenu_MenuLabel:focus {  background-color: #E8E8E8}
.CtxtMenu_ContextMenu:focus {  outline:none}
.CtxtMenu_ContextMenu .CtxtMenu_MenuItem:focus {  outline:none}
.CtxtMenu_SelectionMenu {  position:relative; float:left;  border-bottom: none; -webkit-box-shadow:none; -webkit-border-radius:0px; }
.CtxtMenu_SelectionItem {  padding-right: 1em;}
.CtxtMenu_Selection {  right: 40%; width:50%; }
.CtxtMenu_SelectionBox {  padding: 0em; max-height:20em; max-width: none;  background-color:#FFFFFF;}
.CtxtMenu_SelectionDivider {  clear: both; border-top: 2px solid #000000;}
.CtxtMenu_Menu .CtxtMenu_MenuClose {  top:-10px; left:-10px}
</style>
<style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --bg-color: #f4f6f7;
            --text-color: #333;
        }

        * { box-sizing: border-box; }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 15px; min-height: 100vh; }
        
        .container { max-width: 950px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        
        h1 { color: var(--secondary-color); text-align: center; margin-top: 0; font-size: 1.8em; }
        h2, h3 { color: var(--secondary-color); text-align: center; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s; color: white; margin: 2px; display: inline-block; }
        .btn-primary { background-color: var(--primary-color); }
        .btn-secondary { background-color: var(--secondary-color); }
        .btn-danger { background-color: var(--accent-color); }
        .btn-success { background-color: var(--success-color); }
        .btn-warning { background-color: var(--warning-color); color: #fff; }
        .btn-purple { background-color: #9b59b6; color: white; }
        .btn-info { background-color: #17a2b8; color: white; }
        .btn-orange { background-color: #fd7e14; color: white; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-sm { padding: 5px 10px; font-size: 0.85em; }

        /* N√∫t Back Home N·ªïi b·∫≠t */
        .btn-big-home {
            background-color: #e67e22;
            color: white;
            padding: 15px 30px;
            font-size: 1.1em;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 5px 15px rgba(230, 126, 34, 0.4);
            margin-top: 20px;
            width: 100%;
            max-width: 300px;
        }
        .btn-big-home:hover { background-color: #d35400; transform: translateY(-2px); box-shadow: 0 8px 20px rgba(230, 126, 34, 0.6); }

        .screen { display: none; animation: fadeIn 0.5s; }
        .screen.active { display: block; }

        /* HEADER */
        .sticky-header { 
            position: sticky; top: 0; 
            background: var(--secondary-color); 
            color: white; 
            padding: 10px 15px; 
            border-radius: 0 0 8px 8px; 
            margin: -30px -30px 20px -30px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            z-index: 100; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); 
            font-size: 1em;
        }
        .header-left { width: 30%; flex: none; text-align: left; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        .header-center { flex: 1; text-align: center; font-weight: bold; color: #f1c40f; text-transform: uppercase; font-size: 0.9em; }
        .header-right { width: 30%; flex: none; text-align: right; font-family: monospace; font-size: 1.2em; font-weight: bold; }

        .timer-warning { color: var(--accent-color); animation: pulse 1s infinite; }

        .question-card { background: #fff; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
        .question-title { font-weight: 700; font-size: 1.1em; margin-bottom: 15px; color: var(--secondary-color); }
        
        .code-block { background-color: #282c34; color: #abb2bf; padding: 15px; border-radius: 6px; font-family: 'Consolas', 'Monaco', monospace; margin: 10px 0; border: 1px solid #444; position: relative; overflow-x: auto; font-size: 0.9em; }
        .code-lang-badge { position: absolute; top: 0; right: 0; background: #4b5363; color: #fff; font-size: 0.7em; padding: 2px 8px; border-bottom-left-radius: 4px; font-weight: bold; }
        
        .math-block { margin: 10px 0; padding: 5px; overflow-x: auto; font-size: 1.1em; color: #2c3e50; }
        .quiz-image { max-width: 100%; height: auto; display: block; margin: 15px auto; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); border: 1px solid #eee; }

        .option-label { display: flex; align-items: flex-start; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; margin-bottom: 8px; transition: 0.2s; }
        .option-label input { margin-top: 5px; margin-right: 10px; flex-shrink: 0; }
        .option-label:hover { background-color: #f8f9fa; }
        .option-label.checked { border-color: var(--primary-color); background-color: #ebf5fb; }
        .option-label.correct { background-color: #d4efdf; border-color: var(--success-color); }
        .option-label.incorrect { background-color: #fadbd8; border-color: var(--accent-color); }
        
        .explanation { background: #fff9c4; padding: 10px; border-left: 4px solid #fbc02d; display: none; margin-top: 10px; font-size: 0.95em;}
        .result-box { text-align: center; background: #fff; border: 2px solid var(--secondary-color); padding: 30px; border-radius: 8px; margin-top: 20px; display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }

        .manager-section { margin-top: 40px; border-top: 2px dashed #ddd; padding-top: 20px; }
        .config-section { background: #f1f8ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #d1e5f5; text-align: center;}
        
        .time-config-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; max-width: 400px; margin-left: auto; margin-right: auto; }
        .big-checkbox { transform: scale(1.5); margin-left: 5px; }

        .q-list-item { background: #f9f9f9; padding: 10px; margin-bottom: 8px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #eee; }
        .q-list-content { flex-grow: 1; margin-right: 10px; font-size: 0.9em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .q-subject-badge { font-size: 0.75em; background: #e0e0e0; padding: 2px 6px; border-radius: 4px; margin-right: 5px; color: #555; }
        .q-actions { display: flex; gap: 5px; flex-shrink: 0;}
        .data-controls { margin-bottom: 15px; background: #ecf0f1; padding: 10px; border-radius: 8px; }

        .admin-login-box { text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef; }
        .admin-login-box input { padding: 10px; border: 1px solid #ccc; border-radius: 4px; width: 100%; max-width: 250px; margin-bottom: 10px; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 200; display: none; align-items: center; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: white; width: 95%; max-width: 650px; max-height: 90vh; overflow-y: auto; padding: 20px; border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9em; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-family: inherit; font-size: 1em; }
        textarea.form-control { resize: vertical; min-height: 80px; }
        
        .paste-area { border: 2px dashed #ccc; background: #fafafa; padding: 20px; text-align: center; border-radius: 6px; cursor: pointer; transition: 0.2s; position: relative; }
        .paste-area:hover { border-color: var(--primary-color); background: #eef7ff; }
        .img-preview-box { max-width: 100%; max-height: 200px; margin-top: 10px; display: none; border-radius: 4px; object-fit: contain;}

        .option-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .option-check { transform: scale(1.3); cursor: pointer; flex-shrink: 0; }
        .btn-remove-opt { color: var(--accent-color); background: none; border: none; font-size: 1.5em; cursor: pointer; padding: 0 5px; }

        /* TABLE & RANKING */
        .rank-section { margin-top: 40px; padding-top: 20px; border-top: 4px solid #eee; }
        
        .history-scroll-box {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.05);
        }

        .rank-table { width: 100%; border-collapse: collapse; min-width: 500px; }
        .rank-table th, .rank-table td { padding: 10px; border-bottom: 1px solid #eee; text-align: center; font-size: 0.9em; }
        
        .rank-table th { 
            background-color: var(--secondary-color); 
            color: white; 
            position: sticky; 
            top: 0; 
            z-index: 10;
        }
        .rank-table tr:nth-child(even) { background-color: #f9f9f9; }
        
        .name-input-group { display: flex; gap: 15px; margin: 20px 0; align-items: flex-end; }
        .input-wrapper { display: flex; flex-direction: column; }
        .box-subject { flex: 1; } 
        .box-name { flex: 1; }

        .name-label { font-weight: bold; font-size: 0.95em; color: var(--secondary-color); margin-bottom: 5px; }
        .name-input, .subject-select { padding: 12px; font-size: 1em; border: 2px solid #ddd; border-radius: 6px; width: 100%; outline: none; transition: 0.3s; }
        .name-input:focus, .subject-select:focus { border-color: var(--primary-color); }

        .admin-tabs { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 15px; overflow-x: auto; }
        .admin-tab { padding: 10px 15px; cursor: pointer; border: 1px solid transparent; border-bottom: none; border-radius: 6px 6px 0 0; color: #666; font-weight: 600; white-space: nowrap; }
        .admin-tab.active { background: white; border-color: #ddd; border-bottom-color: white; color: var(--primary-color); margin-bottom: -2px; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        @media (max-width: 768px) {
            .container { padding: 15px; margin: 0; border-radius: 0; box-shadow: none; max-width: 100%; }
            .sticky-header { margin: -15px -15px 15px -15px; border-radius: 0; }
            .name-input-group { flex-direction: column; gap: 15px; }
            .box-subject, .box-name { width: 100%; flex: none; }
            .btn-group { flex-direction: column; }
            .btn-group .btn { width: 100%; margin: 5px 0; }
            .data-controls { display: flex; flex-direction: column; gap: 10px; }
            .data-controls button { width: 100%; }
            .q-list-item { align-items: flex-start; }
            .header-left { font-size: 0.9em; }
            .header-center { display: none; } 
            .time-config-row { justify-content: center; gap: 20px; }
        }
    </style>
<style id="MJX-CHTML-styles">
mjx-container[jax="CHTML"] {
  line-height: 0;
}

mjx-container [space="1"] {
  margin-left: .111em;
}

mjx-container [space="2"] {
  margin-left: .167em;
}

mjx-container [space="3"] {
  margin-left: .222em;
}

mjx-container [space="4"] {
  margin-left: .278em;
}

mjx-container [space="5"] {
  margin-left: .333em;
}

mjx-container [rspace="1"] {
  margin-right: .111em;
}

mjx-container [rspace="2"] {
  margin-right: .167em;
}

mjx-container [rspace="3"] {
  margin-right: .222em;
}

mjx-container [rspace="4"] {
  margin-right: .278em;
}

mjx-container [rspace="5"] {
  margin-right: .333em;
}

mjx-container [size="s"] {
  font-size: 70.7%;
}

mjx-container [size="ss"] {
  font-size: 50%;
}

mjx-container [size="Tn"] {
  font-size: 60%;
}

mjx-container [size="sm"] {
  font-size: 85%;
}

mjx-container [size="lg"] {
  font-size: 120%;
}

mjx-container [size="Lg"] {
  font-size: 144%;
}

mjx-container [size="LG"] {
  font-size: 173%;
}

mjx-container [size="hg"] {
  font-size: 207%;
}

mjx-container [size="HG"] {
  font-size: 249%;
}

mjx-container [width="full"] {
  width: 100%;
}

mjx-box {
  display: inline-block;
}

mjx-block {
  display: block;
}

mjx-itable {
  display: inline-table;
}

mjx-row {
  display: table-row;
}

mjx-row > * {
  display: table-cell;
}

mjx-mtext {
  display: inline-block;
}

mjx-mstyle {
  display: inline-block;
}

mjx-merror {
  display: inline-block;
  color: red;
  background-color: yellow;
}

mjx-mphantom {
  visibility: hidden;
}

_::-webkit-full-page-media, _:future, :root mjx-container {
  will-change: opacity;
}

mjx-assistive-mml {
  position: absolute !important;
  top: 0px;
  left: 0px;
  clip: rect(1px, 1px, 1px, 1px);
  padding: 1px 0px 0px 0px !important;
  border: 0px !important;
  display: block !important;
  width: auto !important;
  overflow: hidden !important;
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  -khtml-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

mjx-assistive-mml[display="block"] {
  width: 100% !important;
}

mjx-c::before {
  display: block;
  width: 0;
}

.MJX-TEX {
  font-family: MJXZERO, MJXTEX;
}

.TEX-B {
  font-family: MJXZERO, MJXTEX-B;
}

.TEX-I {
  font-family: MJXZERO, MJXTEX-I;
}

.TEX-MI {
  font-family: MJXZERO, MJXTEX-MI;
}

.TEX-BI {
  font-family: MJXZERO, MJXTEX-BI;
}

.TEX-S1 {
  font-family: MJXZERO, MJXTEX-S1;
}

.TEX-S2 {
  font-family: MJXZERO, MJXTEX-S2;
}

.TEX-S3 {
  font-family: MJXZERO, MJXTEX-S3;
}

.TEX-S4 {
  font-family: MJXZERO, MJXTEX-S4;
}

.TEX-A {
  font-family: MJXZERO, MJXTEX-A;
}

.TEX-C {
  font-family: MJXZERO, MJXTEX-C;
}

.TEX-CB {
  font-family: MJXZERO, MJXTEX-CB;
}

.TEX-FR {
  font-family: MJXZERO, MJXTEX-FR;
}

.TEX-FRB {
  font-family: MJXZERO, MJXTEX-FRB;
}

.TEX-SS {
  font-family: MJXZERO, MJXTEX-SS;
}

.TEX-SSB {
  font-family: MJXZERO, MJXTEX-SSB;
}

.TEX-SSI {
  font-family: MJXZERO, MJXTEX-SSI;
}

.TEX-SC {
  font-family: MJXZERO, MJXTEX-SC;
}

.TEX-T {
  font-family: MJXZERO, MJXTEX-T;
}

.TEX-V {
  font-family: MJXZERO, MJXTEX-V;
}

.TEX-VB {
  font-family: MJXZERO, MJXTEX-VB;
}

mjx-stretchy-v mjx-c, mjx-stretchy-h mjx-c {
  font-family: MJXZERO, MJXTEX-S1, MJXTEX-S4, MJXTEX, MJXTEX-A ! important;
}

@font-face /* 0 */ {
  font-family: MJXZERO;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Zero.woff") format("woff");
}

@font-face /* 1 */ {
  font-family: MJXTEX;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Main-Regular.woff") format("woff");
}

@font-face /* 2 */ {
  font-family: MJXTEX-B;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Main-Bold.woff") format("woff");
}

@font-face /* 3 */ {
  font-family: MJXTEX-I;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Math-Italic.woff") format("woff");
}

@font-face /* 4 */ {
  font-family: MJXTEX-MI;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Main-Italic.woff") format("woff");
}

@font-face /* 5 */ {
  font-family: MJXTEX-BI;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Math-BoldItalic.woff") format("woff");
}

@font-face /* 6 */ {
  font-family: MJXTEX-S1;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Size1-Regular.woff") format("woff");
}

@font-face /* 7 */ {
  font-family: MJXTEX-S2;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Size2-Regular.woff") format("woff");
}

@font-face /* 8 */ {
  font-family: MJXTEX-S3;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Size3-Regular.woff") format("woff");
}

@font-face /* 9 */ {
  font-family: MJXTEX-S4;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Size4-Regular.woff") format("woff");
}

@font-face /* 10 */ {
  font-family: MJXTEX-A;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_AMS-Regular.woff") format("woff");
}

@font-face /* 11 */ {
  font-family: MJXTEX-C;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Calligraphic-Regular.woff") format("woff");
}

@font-face /* 12 */ {
  font-family: MJXTEX-CB;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Calligraphic-Bold.woff") format("woff");
}

@font-face /* 13 */ {
  font-family: MJXTEX-FR;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Fraktur-Regular.woff") format("woff");
}

@font-face /* 14 */ {
  font-family: MJXTEX-FRB;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Fraktur-Bold.woff") format("woff");
}

@font-face /* 15 */ {
  font-family: MJXTEX-SS;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_SansSerif-Regular.woff") format("woff");
}

@font-face /* 16 */ {
  font-family: MJXTEX-SSB;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_SansSerif-Bold.woff") format("woff");
}

@font-face /* 17 */ {
  font-family: MJXTEX-SSI;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_SansSerif-Italic.woff") format("woff");
}

@font-face /* 18 */ {
  font-family: MJXTEX-SC;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Script-Regular.woff") format("woff");
}

@font-face /* 19 */ {
  font-family: MJXTEX-T;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Typewriter-Regular.woff") format("woff");
}

@font-face /* 20 */ {
  font-family: MJXTEX-V;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Vector-Regular.woff") format("woff");
}

@font-face /* 21 */ {
  font-family: MJXTEX-VB;
  src: url("https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2/MathJax_Vector-Bold.woff") format("woff");
}
</style></head>
<body>
<div class="container">
<div class="screen active" id="start-screen">
<h1>Test Tr·∫Øc Nghi·ªám Pro</h1>
<div class="name-input-group">
<div class="input-wrapper box-subject">
<span class="name-label">M√¥n thi:</span>
<select class="subject-select" id="user-subject-select" onchange="Manager.rememberSubject(); QuizApp.updateSubjectInfo()"><option value="ALL">T·∫•t c·∫£ m√¥n</option><option value="Chung">Chung</option></select>
</div>
<div class="input-wrapper box-name">
<span class="name-label">H·ªç v√† T√™n th√≠ sinh:</span>
<input class="name-input" id="student-name" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n..." required="" type="text">
</div>
</div>
<div class="config-section">
<p id="subject-info-display" style="font-weight: bold; color: var(--primary-color); margin-bottom: 10px;">T·ªïng s·ªë c√¢u h·ªèi: 0</p>
<h3>C·∫•u h√¨nh b√†i thi</h3>
<div class="time-config-row">
<div style="display:flex; align-items:center; gap:5px;">
<label>Gi·ªõi h·∫°n:</label>
<input disabled="" id="quiz-duration" min="1" style="padding:5px; width:70px; text-align:center;" type="number" value="60"> ph√∫t
                </div>
<label style="cursor: pointer; font-weight: bold; color: var(--primary-color); display: flex; align-items: center;">
                    Kh√¥ng gi·ªõi h·∫°n th·ªùi gian
                    <input checked="" class="big-checkbox" id="unlimited-time" onchange="Manager.toggleTimeInput()" type="checkbox">
</label>
</div>
<div class="btn-group" style="display: flex; gap: 10px; justify-content: center;">
<button class="btn btn-secondary" onclick="QuizApp.start(false)">Th·ª© t·ª± g·ªëc</button>
<button class="btn btn-primary" onclick="QuizApp.start(true)">Tr·ªôn c√¢u h·ªèi &amp; ƒê·∫£o ƒë√°p √°n</button>
</div>
</div>
<div class="manager-section">
<h3 style="margin-bottom: 15px;">Khu v·ª±c Admin</h3>
<div class="admin-login-box" id="admin-login-panel" style="display: block;">
<p>Nh·∫≠p m·∫≠t kh·∫©u</p>
<input id="admin-password-input" onkeypress="handleEnterLogin(event)" placeholder="M·∫≠t kh·∫©u" type="password">
<br>
<button class="btn btn-secondary" onclick="checkAdminLogin()">M·ªü kh√≥a</button>
</div>
<div id="admin-content-panel" style="display: none;">
<div class="admin-tabs">
<div class="admin-tab active" onclick="Manager.switchTab('questions')">Ng√¢n h√†ng c√¢u h·ªèi</div>
<div class="admin-tab" onclick="Manager.switchTab('subjects')">Qu·∫£n l√Ω M√¥n thi</div>
<div class="admin-tab" onclick="Manager.switchTab('settings')">C√†i ƒë·∫∑t &amp; B·∫£o m·∫≠t</div>
</div>
<div id="tab-questions" style="display: block;">
<div class="data-controls">
<button class="btn btn-purple" onclick="DataManager.saveAsHtml()" style="width: 100%; margin-bottom:10px;">üíæ L∆∞u to√†n b·ªô d·ªØ li·ªáu (HTML)</button>
<div style="display: flex; gap: 5px; flex-wrap: wrap; justify-content: center;">
<button class="btn btn-success btn-sm" onclick="DataManager.exportExcel()">‚¨á Xu·∫•t Excel</button>
<button class="btn btn-secondary btn-sm" onclick="document.getElementById('file-upload').click()">‚¨Ü Nh·∫≠p Excel</button>
<button class="btn btn-warning btn-sm" onclick="DataManager.exportCSV_Native()">‚¨á Xu·∫•t CSV</button>
<button class="btn btn-orange btn-sm" onclick="document.getElementById('file-upload-csv').click()">‚¨Ü Nh·∫≠p CSV</button>
<input accept=".xlsx, .xls" id="file-upload" onchange="DataManager.importExcel(this)" style="display: none;" type="file">
<input accept=".csv" id="file-upload-csv" onchange="DataManager.importCSV_Native(this)" style="display: none;" type="file">
<button class="btn btn-info btn-sm" onclick="DataManager.reloadFromHTML()">‚Ü∫ Reload code html</button>
<button class="btn btn-danger btn-sm" onclick="DataManager.resetDefault()">‚ö† Delete all data</button>
</div>
<div class="data-controls" style="margin-top: 10px; border-top: 2px dashed #bdc3c7; padding-top: 10px;">
<p style="font-weight:bold; margin-bottom:5px; color: var(--secondary-color);">‚òÅ Cloud / Google Sheet Database</p>
<div style="margin-bottom: 8px;">
<button class="btn btn-secondary btn-sm" onclick="DataManager.exportJSON()">‚¨á Xu·∫•t file JSON (Backup)</button>
<button class="btn btn-orange btn-sm" onclick="document.getElementById('json-upload').click()">‚¨Ü N·∫°p file JSON</button>
<input accept=".json" id="json-upload" onchange="DataManager.importJSONFile(this)" style="display: none;" type="file">
</div>
<div style="display:flex; gap:5px;">
<input class="form-control" id="cloud-url" placeholder="D√°n Link JSON (Apps Script URL)..." style="font-size: 0.9em;" type="text">
<button class="btn btn-primary btn-sm" onclick="DataManager.loadFromCloud()">üîó Link &amp; T·∫£i v·ªÅ</button>
</div>
<p style="font-size:0.75em; color:#666; margin-top:3px;">
        * ƒê·ªÉ d√πng Google Sheet: T·∫°o Apps Script v·ªõi h√†m <code>doGet</code> tr·∫£ v·ªÅ JSON.
    </p>
</div>
<p style="font-size:0.8em; color:#666; text-align:center; margin-top:5px;">
                            * <b>CSV</b> ch·∫°y ƒë∆∞·ª£c Offline. <b>Excel</b> c·∫ßn m·∫°ng ho·∫∑c t·∫£i s·∫µn th∆∞ vi·ªán.
                        </p>
</div>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; margin-top: 20px;">
<div>
<select class="form-control" id="admin-filter-subject" onchange="Manager.renderList()" style="width: auto; display: inline-block; padding: 5px;"><option value="ALL">-- T·∫•t c·∫£ m√¥n --</option><option value="Chung">Chung</option></select>
<span style="font-size:0.9em;">T·ªïng: <b id="total-questions-count">0</b></span>
</div>
<button class="btn btn-success btn-sm" onclick="Manager.openModal()">+ Th√™m</button>
</div>
<div id="question-list-container" style="max-height: 400px; overflow-y: auto;"></div>
</div>
<div id="tab-subjects" style="display: none;">
<h4>Danh s√°ch m√¥n thi</h4>
<div style="display: flex; gap: 10px; margin-bottom: 15px;">
<input class="form-control" id="new-subject-input" placeholder="T√™n m√¥n m·ªõi..." type="text">
<button class="btn btn-success" onclick="Manager.addSubject()">Th√™m</button>
</div>
<ul id="subject-list-ui" style="list-style: none; padding: 0;"></ul>
<p style="font-size: 0.8em; color: #666;">* Kh√¥ng th·ªÉ x√≥a m√¥n ƒëang c√≥ c√¢u h·ªèi.</p>
</div>
<div id="tab-settings" style="display: none;">
<h4>ƒê·ªïi m·∫≠t kh·∫©u Admin</h4>
<p style="font-size:0.9em; color:#555;">M·∫≠t kh·∫©u s·∫Ω ƒë∆∞·ª£c m√£ h√≥a <b>SHA-256</b>.</p>
<div class="form-group">
<label class="form-label">M·∫≠t kh·∫©u c≈©:</label>
<input class="form-control" id="old-pass" type="password">
</div>
<div class="form-group">
<label class="form-label">M·∫≠t kh·∫©u m·ªõi:</label>
<input class="form-control" id="new-pass" type="password">
</div>
<button class="btn btn-primary" onclick="Manager.changePassword()">L∆∞u m·∫≠t kh·∫©u</button>
</div>
<div style="text-align: right; margin-top: 20px; border-top: 1px solid #eee; padding-top: 10px;">
<button class="btn btn-secondary btn-sm" onclick="lockAdmin()">üîí Kh√≥a Admin</button>
</div>
</div>
</div>
<div class="rank-section" id="leaderboard-ui">
<h3>üìã L·ªãch s·ª≠ l√†m b√†i test</h3>
<div class="history-scroll-box">
<table class="rank-table">
<thead>
<tr>
<th width="10%">STT</th>
<th width="30%">H·ªç T√™n</th>
<th width="15%">M√¥n</th>
<th width="15%">ƒê√∫ng/T·ªïng</th>
<th width="15%">ƒêi·ªÉm</th>
<th width="15%">Ng√†y</th>
</tr>
</thead>
<tbody id="rank-body"><tr><td colspan="6">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr></tbody>
</table>
</div>
</div>
</div>
<div class="screen" id="quiz-screen">
<div class="sticky-header">
<div class="header-left">
                üë§ <span id="display-student-name">Tran Anh</span>
</div>
<div class="header-center">
<span id="display-subject-name">C·∫•u tr√∫c d·ªØ li·ªáu &amp; thu·∫≠t to√°n</span>
</div>
<div class="header-right" id="timer-display">‚àû</div>
</div>
<div id="quiz-container" style="margin-top: 20px;"></div>
<button class="btn btn-primary" id="submit-btn" onclick="QuizApp.submit()" style="width: 100%; margin-top: 20px; padding: 15px; display: none;">N·ªòP B√ÄI</button>
<div class="result-box" id="result-box" style="display: block;">
<h3 style="color: var(--secondary-color);">K·∫æT QU·∫¢</h3>
<p style="font-size: 1.2em;">S·ªë c√¢u ƒë√∫ng: <b id="correct-count" style="color:var(--success-color)">11</b> / <span id="total-count">140</span></p>
<div id="final-score" style="font-size: 4em; font-weight: bold; margin: 10px 0; color: var(--primary-color);">0.8</div>
<button class="btn btn-big-home" onclick="QuizApp.resetToHome()">Quay l·∫°i m√†n h√¨nh ch√≠nh</button>
</div>
</div>
</div>
<div class="modal-overlay" id="editor-modal">
<div class="modal-content">
<h3 id="modal-title">Th√™m c√¢u h·ªèi m·ªõi</h3>
<input id="edit-index" type="hidden" value="-1">
<div class="form-group">
<label class="form-label">M√¥n thi:</label>
<select class="form-control" id="inp-subject"><option value="Chung">Chung</option></select>
</div>
<div class="form-group">
<label class="form-label">N·ªôi dung c√¢u h·ªèi:</label>
<textarea class="form-control" id="inp-question" placeholder="Nh·∫≠p c√¢u h·ªèi..." rows="2" style="height: 155px;"></textarea>
</div>
<div class="form-group">
<label class="form-label">H√¨nh ·∫£nh (Optional):</label>
<input id="inp-image-data" type="hidden" value="">
<div class="paste-area" id="paste-area">
<p style="margin: 0; color: #777;">Paste (Ctrl+V) ho·∫∑c Click ch·ªçn ·∫£nh</p>
<input accept="image/*" id="inp-file-hidden" onchange="Manager.handleFileSelect(this)" style="display:none;" type="file">
<img alt="Preview" class="img-preview-box" id="img-preview" src="" style="display: none;">
<br>
<button class="btn btn-danger btn-sm" id="btn-clear-img" onclick="Manager.clearImage()" style="display: none; margin-top: 10px;" type="button">X√≥a ·∫£nh</button>
</div>
</div>
<div class="form-group">
<label class="form-label">C√¥ng th·ª©c To√°n (LaTeX):</label>
<textarea class="form-control" id="inp-math" placeholder="V√≠ d·ª•: $ x = \frac{-b \pm \sqrt{\Delta}}{2a} $" style="background: #fdfefe;"></textarea>
</div>
<div class="form-group">
<label class="form-label">Code (Optional):</label>
<div style="display: flex; gap: 5px; margin-bottom: 5px;">
<select class="form-control" id="inp-code-lang" style="width: auto;">
<option value="plaintext">Text</option>
<option value="cpp">C/C++</option>
<option value="csharp">C#</option>
<option value="python">Python</option>
<option value="javascript">JS</option>
</select>
</div>
<textarea class="form-control" id="inp-code" placeholder="D√°n code v√†o ƒë√¢y..." rows="4" style="font-family: monospace; background: #282c34; color: #fff;"></textarea>
</div>
<div class="form-group">
<label class="form-label">Lo·∫°i c√¢u h·ªèi:</label>
<select class="form-control" id="inp-type" onchange="Manager.changeType()">
<option value="single">Ch·ªçn 1 ƒë√°p √°n ƒë√∫ng</option>
<option value="multi">Ch·ªçn nhi·ªÅu ƒë√°p √°n</option>
</select>
</div>
<div class="form-group">
<label class="form-label">C√°c ƒë√°p √°n (Check v√†o ƒë√°p √°n ƒë√∫ng):</label>
<div id="options-container"><div class="option-row">
<input class="option-check" name="correct_ans_selector" type="radio">
<input class="form-control option-text" placeholder="Nh·∫≠p ƒë√°p √°n..." type="text" value="">
<button class="btn-remove-opt" onclick="this.parentElement.remove()" type="button">√ó</button>
</div><div class="option-row">
<input class="option-check" name="correct_ans_selector" type="radio">
<input class="form-control option-text" placeholder="Nh·∫≠p ƒë√°p √°n..." type="text" value="">
<button class="btn-remove-opt" onclick="this.parentElement.remove()" type="button">√ó</button>
</div><div class="option-row">
<input class="option-check" name="correct_ans_selector" type="radio">
<input class="form-control option-text" placeholder="Nh·∫≠p ƒë√°p √°n..." type="text" value="">
<button class="btn-remove-opt" onclick="this.parentElement.remove()" type="button">√ó</button>
</div><div class="option-row">
<input class="option-check" name="correct_ans_selector" type="radio">
<input class="form-control option-text" placeholder="Nh·∫≠p ƒë√°p √°n..." type="text" value="">
<button class="btn-remove-opt" onclick="this.parentElement.remove()" type="button">√ó</button>
</div></div>
<button class="btn btn-secondary btn-sm" onclick="Manager.addOptionUI()" style="margin-top: 5px;" type="button">+ Th√™m d√≤ng</button>
</div>
<div class="form-group">
<label class="form-label">Gi·∫£i th√≠ch:</label>
<input class="form-control" id="inp-note" placeholder="Gi·∫£i th√≠ch v√¨ sao ƒë√∫ng..." type="text">
</div>
<div style="text-align: right; margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
<button class="btn btn-secondary" onclick="Manager.closeModal()">H·ªßy (Esc)</button>
<button class="btn btn-primary" onclick="Manager.saveQuestion()">L∆∞u</button>
</div>
</div>
</div>
<script>
    // ==========================================
    // KHU V·ª∞C D·ªÆ LI·ªÜU
    // ==========================================
    
    // Hash SHA256 m·∫∑c ƒë·ªãnh cho "."
    let GLOBAL_DATA = {
    "questions": [],
    "subjects": [],
    "leaderboard": []
}/*DATA_END*/;

    let QUESTION_DB = GLOBAL_DATA.questions;

    // ==========================================
    // UTILITIES
    // ==========================================
    const Utils = {
        sha256: function(ascii) {
            function rightRotate(value, amount) { return (value>>>amount) | (value<<(32 - amount)); }
            
            var mathPow = Math.pow;
            var maxWord = mathPow(2, 32);
            var lengthProperty = 'length';
            var i, j;
            var result = '';
            var words = [];
            var asciiBitLength = ascii[lengthProperty]*8;
            var hash = [0x6a09e667, 0xbb67ae85, 0x3c6ef372, 0xa54ff53a, 0x510e527f, 0x9b05688c, 0x1f83d9ab, 0x5be0cd19];
            var k = [0x428a2f98, 0x71374491, 0xb5c0fbcf, 0xe9b5dba5, 0x3956c25b, 0x59f111f1, 0x923f82a4, 0xab1c5ed5,
                     0xd807aa98, 0x12835b01, 0x243185be, 0x550c7dc3, 0x72be5d74, 0x80deb1fe, 0x9bdc06a7, 0xc19bf174,
                     0xe49b69c1, 0xefbe4786, 0x0fc19dc6, 0x240ca1cc, 0x2de92c6f, 0x4a7484aa, 0x5cb0a9dc, 0x76f988da,
                     0x983e5152, 0xa831c66d, 0xb00327c8, 0xbf597fc7, 0xc6e00bf3, 0xd5a79147, 0x06ca6351, 0x14292967,
                     0x27b70a85, 0x2e1b2138, 0x4d2c6dfc, 0x53380d13, 0x650a7354, 0x766a0abb, 0x81c2c92e, 0x92722c85,
                     0xa2bfe8a1, 0xa81a664b, 0xc24b8b70, 0xc76c51a3, 0xd192e819, 0xd6990624, 0xf40e3585, 0x106aa070,
                     0x19a4c116, 0x1e376c08, 0x2748774c, 0x34b0bcb5, 0x391c0cb3, 0x4ed8aa4a, 0x5b9cca4f, 0x682e6ff3,
                     0x748f82ee, 0x78a5636f, 0x84c87814, 0x8cc70208, 0x90befffa, 0xa4506ceb, 0xbef9a3f7, 0xc67178f2];
            
            ascii += '\x80'; 
            while (ascii[lengthProperty]%64 - 56) ascii += '\x00'; 
            for (i = 0; i < ascii[lengthProperty]; i++) {
                j = ascii.charCodeAt(i);
                if (j>>8) return; 
                words[i>>2] |= j << ((3 - i)%4)*8;
            }
            words[words[lengthProperty]] = ((asciiBitLength/maxWord)|0);
            words[words[lengthProperty]] = (asciiBitLength)
            
            for (j = 0; j < words[lengthProperty];) {
                var w = words.slice(j, j += 16);
                var oldHash = hash;
                hash = hash.slice(0, 8);
                
                for (i = 0; i < 64; i++) {
                    var i2 = i + j;
                    var w15 = w[i - 15], w2 = w[i - 2];
                    var a = hash[0], e = hash[4];
                    var temp1 = hash[7] + (rightRotate(e, 6) ^ rightRotate(e, 11) ^ rightRotate(e, 25)) + ((e&hash[5])^((~e)&hash[6])) + k[i] + (w[i] = (i < 16) ? w[i] : (
                        w[i - 16] + (rightRotate(w15, 7) ^ rightRotate(w15, 18) ^ (w15>>>3)) + w[i - 7] + (rightRotate(w2, 17) ^ rightRotate(w2, 19) ^ (w2>>>10))
                    )|0);
                    var temp2 = (rightRotate(a, 2) ^ rightRotate(a, 13) ^ rightRotate(a, 22)) + ((a&hash[1])^(a&hash[2])^(hash[1]&hash[2]));
                    
                    hash = [(temp1 + temp2)|0].concat(hash); 
                    hash[4] = (hash[4] + temp1)|0;
                }
                for (i = 0; i < 8; i++) hash[i] = (hash[i] + oldHash[i])|0;
            }
            
            for (i = 0; i < 8; i++) {
                for (j = 3; j + 1; j--) {
                    var b = (hash[i]>>(j*8))&255;
                    result += ((b < 16) ? 0 : '') + b.toString(16);
                }
            }
            return result;
        },

        escapeHtml: function(text) {
            if (!text) return "";
            return String(text).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
        }
    };

    // ==========================================
    // AUTHENTICATION
    // ==========================================
    function checkAdminLogin() {
        const inp = document.getElementById('admin-password-input');
        const inputHash = Utils.sha256(inp.value);
        const storedHash = (GLOBAL_DATA.config && GLOBAL_DATA.config.adminHash) ? GLOBAL_DATA.config.adminHash : "a665a45920422f9d417e4867efdc4fb8a04a1f3fff1fa07e998e86f7f7a27ae3";

        if (inputHash === storedHash) {
            document.getElementById('admin-login-panel').style.display = 'none';
            document.getElementById('admin-content-panel').style.display = 'block';
            inp.value = '';
            Manager.renderList();
        } else {
            alert("M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!");
            inp.value = '';
            inp.focus();
        }
    }

    function lockAdmin() {
        document.getElementById('admin-login-panel').style.display = 'block';
        document.getElementById('admin-content-panel').style.display = 'none';
    }
    function handleEnterLogin(e) { if(e.key === 'Enter') checkAdminLogin(); }

    // ==========================================
    // DATA & FILE MANAGER
    // ==========================================
    const DataManager = {
        STORAGE_KEY: 'quiz_app_pro_v5',
        NAME_KEY: 'quiz_app_last_name',
        SUB_KEY: 'quiz_app_last_subject',

        init: function() {
            const savedData = localStorage.getItem(this.STORAGE_KEY);
            if (savedData) {
                try {
                    const parsed = JSON.parse(savedData);
                    if(!parsed.config) parsed.config = GLOBAL_DATA.config;
                    if(!parsed.leaderboard) parsed.leaderboard = [];
                    GLOBAL_DATA = parsed;
                } catch (e) { console.error("Data Parse Error", e); }
            }
            GLOBAL_DATA.questions.forEach(q => {
                if(!q.subject) q.subject = GLOBAL_DATA.config.subjects[0];
            });
            QUESTION_DB = GLOBAL_DATA.questions;

            const lastName = localStorage.getItem(this.NAME_KEY);
            if(lastName) document.getElementById('student-name').value = lastName;

            this.renderLeaderboard();
            Manager.updateSubjectLists();
            
            const lastSub = localStorage.getItem(this.SUB_KEY);
            const userSel = document.getElementById('user-subject-select');
            
            if(lastSub && (lastSub === 'ALL' || GLOBAL_DATA.config.subjects.includes(lastSub))) {
                 userSel.value = lastSub;
            } else {
                 userSel.value = "ALL";
            }

            QuizApp.updateSubjectInfo();
        },

        saveToLocal: function() {
            try {
                localStorage.setItem(this.STORAGE_KEY, JSON.stringify(GLOBAL_DATA));
            } catch (e) { alert("B·ªô nh·ªõ tr√¨nh duy·ªát ƒë·∫ßy!"); }
            Manager.renderList();
            this.renderLeaderboard();
            Manager.updateSubjectLists();
        },

        reloadFromHTML: function() {
            if(!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën load l·∫°i d·ªØ li·ªáu t·ª´ m√£ ngu·ªìn g·ªëc? M·ªçi thay ƒë·ªïi ch∆∞a l∆∞u ra file s·∫Ω m·∫•t.")) return;
            const htmlContent = document.documentElement.outerHTML;
            const regex = /\/\*DATA_START\*\/([\s\S]*?)\/\*DATA_END\*\//;
            const match = htmlContent.match(regex);
            
            if (match && match[1]) {
                try {
                    const codeData = JSON.parse(match[1]);
                    GLOBAL_DATA = codeData;
                    QUESTION_DB = GLOBAL_DATA.questions;
                    this.saveToLocal(); 
                    alert("ƒê√£ kh√¥i ph·ª•c d·ªØ li·ªáu g·ªëc t·ª´ HTML!");
                    location.reload();
                } catch (e) { alert("L·ªói parse JSON t·ª´ HTML: " + e.message); }
            } else {
                alert("Kh√¥ng t√¨m th·∫•y block d·ªØ li·ªáu g·ªëc trong HTML.");
            }
        },

        saveAsHtml: function() {
            const loginPanel = document.getElementById('admin-login-panel');
            const contentPanel = document.getElementById('admin-content-panel');
            const wasLoggedIn = contentPanel.style.display === 'block';
            
            loginPanel.style.display = 'block';
            contentPanel.style.display = 'none';
            document.getElementById('admin-password-input').value = ''; 

            let fullHTML = document.documentElement.outerHTML;
            let jsonData = JSON.stringify(GLOBAL_DATA, null, 4);
            const regex = /\/\*DATA_START\*\/[\s\S]*?\/\*DATA_END\*\//;
            
            if (wasLoggedIn) {
                loginPanel.style.display = 'none';
                contentPanel.style.display = 'block';
            }

            if (regex.test(fullHTML)) {
                const newContent = `/*DATA_START*/{
    "questions": [],
    "leaderboard": [],
    "config": {
        "subjects": [
            "Chung"
        ],
        "adminHash": "a665a45920422f9d417e4867efdc4fb8a04a1f3fff1fa07e998e86f7f7a27ae3"
    }
}/*DATA_END*/`;
                fullHTML = fullHTML.replace(regex, newContent);
                const blob = new Blob([fullHTML], {type: "text/html"});
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                const d = new Date();
                link.download = `TracNghiem_Pro_${d.getDate()}_${d.getMonth()+1}.html`;
                link.click();
                alert("ƒê√£ t·∫£i xu·ªëng file HTML m·ªõi ch·ª©a to√†n b·ªô d·ªØ li·ªáu!");
            } else {
                alert("L·ªói: Kh√¥ng t√¨m th·∫•y v·ªã tr√≠ d·ªØ li·ªáu trong m√£ ngu·ªìn.");
            }
        },

        _generateDataRows: function() {
             return QUESTION_DB.map(q => {
                let correctText = "";
                if(Array.isArray(q.answer)) {
                    correctText = q.answer.map(i => (q.options[i] || "")).join(" | ");
                } else {
                    correctText = q.options[q.answer] || "";
                }

                return {
                    "M√¥n thi": q.subject || "Chung",
                    "C√¢u h·ªèi": q.question || "",
                    "ƒê√°p √°n ƒë√∫ng (Text)": correctText,
                    "ƒê√°p √°n 1": q.options[0] || "",
                    "ƒê√°p √°n 2": q.options[1] || "",
                    "ƒê√°p √°n 3": q.options[2] || "",
                    "ƒê√°p √°n 4": q.options[3] || "",
                    "Gi·∫£i th√≠ch": q.note || ""
                };
            });
        },

        // --- EXCEL LOGIC (Y√™u c·∫ßu th∆∞ vi·ªán) ---
        _checkExcelLib: function() {
            if(typeof XLSX === 'undefined') {
                alert("‚ùå L·ªói: Th∆∞ vi·ªán Excel (SheetJS) ch∆∞a ƒë∆∞·ª£c t·∫£i!\n\nN·∫øu b·∫°n ƒëang d√πng Offline, vui l√≤ng s·ª≠ d·ª•ng n√∫t 'CSV (Offline)' b√™n c·∫°nh.\nCSV ho·∫°t ƒë·ªông t·ªët m√† kh√¥ng c·∫ßn m·∫°ng.");
                return false;
            }
            return true;
        },

        exportExcel: function() {
            if(!this._checkExcelLib()) return;
            if (QUESTION_DB.length === 0) return alert("Kh√¥ng c√≥ d·ªØ li·ªáu!");
            const rows = this._generateDataRows();
            const worksheet = XLSX.utils.json_to_sheet(rows);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "NganHangCauHoi");
            XLSX.writeFile(workbook, "CauHoi_Export.xlsx");
        },

        importExcel: function(inputElement) {
            if(!this._checkExcelLib()) {
                inputElement.value = ""; 
                return;
            }
            const file = inputElement.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const json = XLSX.utils.sheet_to_json(worksheet);
                DataManager._processImportData(json);
                inputElement.value = "";
            };
            reader.readAsArrayBuffer(file);
        },

        // --- CSV NATIVE LOGIC (Ho·∫°t ƒë·ªông Offline 100%) ---
        exportCSV_Native: function() {
            if (QUESTION_DB.length === 0) return alert("Kh√¥ng c√≥ d·ªØ li·ªáu!");
            const data = this._generateDataRows();
            const headers = ["M√¥n thi", "C√¢u h·ªèi", "ƒê√°p √°n ƒë√∫ng (Text)", "ƒê√°p √°n 1", "ƒê√°p √°n 2", "ƒê√°p √°n 3", "ƒê√°p √°n 4", "Gi·∫£i th√≠ch"];
            
            // X√¢y d·ª±ng n·ªôi dung CSV
            let csvContent = headers.join(",") + "\n";
            
            data.forEach(row => {
                let rowArr = [];
                headers.forEach(header => {
                    let val = row[header] || "";
                    // Escape CSV: n·∫øu c√≥ d·∫•u ph·∫©y ho·∫∑c xu·ªëng d√≤ng, ph·∫£i bao trong ngo·∫∑c k√©p
                    val = String(val).replace(/"/g, '""'); // Escape ngo·∫∑c k√©p
                    if (val.search(/("|,|\n)/g) >= 0) val = `"${val}"`;
                    rowArr.push(val);
                });
                csvContent += rowArr.join(",") + "\n";
            });

            // Th√™m BOM (\uFEFF) ƒë·ªÉ Excel ƒë·ªçc ƒë√∫ng ti·∫øng Vi·ªát
            const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "CauHoi_Offline.csv";
            link.click();
        },

        importCSV_Native: function(inputElement) {
            const file = inputElement.files[0];
            if (!file) return;
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const text = e.target.result;
                const rows = DataManager._parseCSV(text);
                
                if(!rows || rows.length < 2) return alert("File CSV kh√¥ng h·ª£p l·ªá ho·∫∑c r·ªóng!");

                // Chuy·ªÉn m·∫£ng array th√†nh m·∫£ng object json
                const headers = rows[0]; 
                const json = [];
                
                for(let i = 1; i < rows.length; i++) {
                    let rowData = rows[i];
                    if(rowData.length < 2) continue; // B·ªè qua d√≤ng tr·ªëng
                    let obj = {};
                    headers.forEach((h, index) => {
                        obj[h.trim()] = rowData[index];
                    });
                    json.push(obj);
                }
                
                DataManager._processImportData(json);
                inputElement.value = "";
            };
            reader.readAsText(file);
        },

        // Parser CSV th·ªß c√¥ng (ƒë·ªÉ x·ª≠ l√Ω d·∫•u ph·∫©y trong ngo·∫∑c k√©p)
        _parseCSV: function(text) {
            let arr = [];
            let quote = false;  // true n·∫øu ƒëang ·ªü trong chu·ªói "..."
            let row = [], col = "";
            
            for (let c = 0; c < text.length; c++) {
                let cc = text[c], nc = text[c+1];
                
                if (cc === '"') {
                    if (quote && nc === '"') { col += '"'; c++; } // G·∫∑p 2 d·∫•u "" li√™n ti·∫øp -> 1 d·∫•u "
                    else { quote = !quote; } 
                } else if (cc === ',' && !quote) {
                    row.push(col); col = "";
                } else if ((cc === '\r' || cc === '\n') && !quote) {
                    row.push(col); col = "";
                    if(row.length > 0) arr.push(row);
                    row = [];
                    if (cc === '\r' && nc === '\n') c++;
                } else {
                    col += cc;
                }
            }
            if(col.length > 0 || row.length > 0) {
                 row.push(col);
                 arr.push(row);
            }
            return arr;
        },

        _processImportData: function(json) {
            if (json.length === 0) return alert("File r·ªóng ho·∫∑c sai ƒë·ªãnh d·∫°ng!");
            if(confirm(`T√¨m th·∫•y ${json.length} c√¢u h·ªèi. B·∫°n mu·ªën GHI ƒê√à hay TH√äM V√ÄO? (OK = Ghi ƒë√®, Cancel = Th√™m v√†o)`)) {
                GLOBAL_DATA.questions = [];
            }

            json.forEach(row => {
                // FIXED: √âp ki·ªÉu String ƒë·ªÉ tr√°nh l·ªói n·∫øu c√¢u h·ªèi l√† s·ªë
                const qText = String(row["C√¢u h·ªèi"] || row["Question"] || "").trim();
                if(!qText) return;
                
                const subject = String(row["M√¥n thi"] || "Chung").trim();
                if(!GLOBAL_DATA.config.subjects.includes(subject)) {
                    GLOBAL_DATA.config.subjects.push(subject);
                }

                // FIXED: √âp ki·ªÉu String cho ƒë√°p √°n ƒë√∫ng
                const correctText = String(row["ƒê√°p √°n ƒë√∫ng (Text)"] || "").trim();
                const note = String(row["Gi·∫£i th√≠ch"] || "");
                
                let opts = [];
                // FIXED: Ki·ªÉm tra != null ƒë·ªÉ nh·∫≠n c·∫£ s·ªë 0
                if(row["ƒê√°p √°n 1"] != null) opts.push(String(row["ƒê√°p √°n 1"]));
                if(row["ƒê√°p √°n 2"] != null) opts.push(String(row["ƒê√°p √°n 2"]));
                if(row["ƒê√°p √°n 3"] != null) opts.push(String(row["ƒê√°p √°n 3"]));
                if(row["ƒê√°p √°n 4"] != null) opts.push(String(row["ƒê√°p √°n 4"]));
                
                let ansIndex = 0;
                // FIXED: So s√°nh String
                const foundIdx = opts.findIndex(o => String(o).trim() === correctText);
                if(foundIdx !== -1) ansIndex = foundIdx;

                GLOBAL_DATA.questions.push({
                    question: qText, options: opts, answer: ansIndex, note: note,
                    subject: subject, image: null, math: null, code: null 
                });
            });
            QUESTION_DB = GLOBAL_DATA.questions;
            DataManager.saveToLocal();
            alert("Nh·∫≠p d·ªØ li·ªáu th√†nh c√¥ng!");
        },

        renderLeaderboard: function() {
            const tbody = document.getElementById('rank-body');
            tbody.innerHTML = '';
            
            const displayList = GLOBAL_DATA.leaderboard.slice(0, 50);
            
            displayList.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td style="font-weight:600">${Utils.escapeHtml(row.name)}</td>
                    <td>${Utils.escapeHtml(row.subject)}</td>
                    <td><span style="color:var(--success-color)">${row.correct}</span>/${row.total}</td>
                    <td style="font-weight:bold; color:var(--primary-color)">${row.score}</td>
                    <td style="font-size:0.85em; color:#777;">${row.date}</td>
                `;
                tbody.appendChild(tr);
            });
            if(displayList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';
            }
        },

        resetDefault: function() {
            if(confirm("X√≥a h·∫øt to√†n b·ªô d·ªØ li·ªáu (C√¢u h·ªèi, L·ªãch s·ª≠, C·∫•u h√¨nh) v·ªÅ tr·∫°ng th√°i r·ªóng?")) {
                GLOBAL_DATA = { 
                    questions: [], leaderboard: [],
                    config: { subjects: ["Chung"], adminHash: Utils.sha256("123") }
                };
                QUESTION_DB = GLOBAL_DATA.questions;
                this.saveToLocal();
                location.reload();
            }
        }
    };

    // ==========================================
    // MANAGER
    // ==========================================
    const Manager = {
        currentTab: 'questions',

        switchTab: function(tabName) {
            this.currentTab = tabName;
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#admin-content-panel > div[id^="tab-"]').forEach(d => d.style.display = 'none');
            document.querySelector(`.admin-tab[onclick="Manager.switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`tab-${tabName}`).style.display = 'block';
            if(tabName === 'subjects') this.renderSubjectList();
        },

        renderList: function() {
            const listContainer = document.getElementById('question-list-container');
            const filterSub = document.getElementById('admin-filter-subject').value;
            
            let filteredDB = QUESTION_DB;
            if(filterSub !== 'ALL') {
                filteredDB = QUESTION_DB.map((q, idx) => ({...q, originalIdx: idx}))
                                        .filter(q => q.subject === filterSub);
            } else {
                filteredDB = QUESTION_DB.map((q, idx) => ({...q, originalIdx: idx}));
            }

            document.getElementById('total-questions-count').innerText = filteredDB.length;
            listContainer.innerHTML = '';
            
            filteredDB.forEach((q) => {
                const div = document.createElement('div');
                div.className = 'q-list-item';
                div.innerHTML = `
                    <div class="q-list-content">
                        <span class="q-subject-badge">${Utils.escapeHtml(q.subject)}</span>
                        <strong>#${q.originalIdx + 1}:</strong> ${Utils.escapeHtml(q.question)}
                    </div>
                    <div class="q-actions">
                        <button class="btn btn-primary btn-sm" onclick="Manager.openModal(${q.originalIdx})">‚úé</button>
                        <button class="btn btn-danger btn-sm" onclick="Manager.deleteQuestion(${q.originalIdx})">üóë</button>
                    </div>`;
                listContainer.appendChild(div);
            });
        },

        deleteQuestion: function(index) {
            if(confirm('X√≥a c√¢u h·ªèi n√†y?')) {
                QUESTION_DB.splice(index, 1);
                DataManager.saveToLocal();
            }
        },

        updateSubjectLists: function() {
            const subs = GLOBAL_DATA.config.subjects;
            const adminFilter = document.getElementById('admin-filter-subject');
            const currentFilter = adminFilter.value;
            adminFilter.innerHTML = '<option value="ALL">-- T·∫•t c·∫£ m√¥n --</option>';
            subs.forEach(s => { adminFilter.innerHTML += `<option value="${s}">${s}</option>`; });
            adminFilter.value = currentFilter;

            const modalSel = document.getElementById('inp-subject');
            modalSel.innerHTML = '';
            subs.forEach(s => { modalSel.innerHTML += `<option value="${s}">${s}</option>`; });

            const userSel = document.getElementById('user-subject-select');
            const currentUserSel = userSel.value;
            
            let userOpts = '<option value="ALL">T·∫•t c·∫£ m√¥n</option>';
            subs.forEach(s => { userOpts += `<option value="${s}">${s}</option>`; });
            userSel.innerHTML = userOpts;

            if(currentUserSel && (currentUserSel === 'ALL' || subs.includes(currentUserSel))) {
                userSel.value = currentUserSel;
            } else {
                 userSel.value = "ALL";
            }
        },

        renderSubjectList: function() {
            const ul = document.getElementById('subject-list-ui');
            ul.innerHTML = '';
            GLOBAL_DATA.config.subjects.forEach((s, idx) => {
                const li = document.createElement('li');
                li.style.padding = "8px";
                li.style.borderBottom = "1px solid #eee";
                li.style.display = "flex";
                li.style.justifyContent = "space-between";
                const count = QUESTION_DB.filter(q => q.subject === s).length;
                
                const deleteBtn = (count === 0 && GLOBAL_DATA.config.subjects.length > 1) 
                    ? `<button class="btn btn-danger btn-sm" onclick="Manager.removeSubject(${idx})">X√≥a</button>` 
                    : `<span style="color:#ccc; font-size:0.8em; margin-left:5px;">(ƒêang d√πng)</span>`;

                li.innerHTML = `
                    <span><b>${s}</b> <small>(${count} c√¢u)</small></span>
                    <div>
                        <button class="btn btn-primary btn-sm" onclick="Manager.editSubject(${idx})">‚úé S·ª≠a</button>
                        ${deleteBtn}
                    </div>
                `;
                ul.appendChild(li);
            });
        },

        addSubject: function() {
            const inp = document.getElementById('new-subject-input');
            const val = inp.value.trim();
            if(!val) return alert("Ch∆∞a nh·∫≠p t√™n m√¥n!");
            if(GLOBAL_DATA.config.subjects.includes(val)) return alert("M√¥n n√†y ƒë√£ t·ªìn t·∫°i!");
            
            GLOBAL_DATA.config.subjects.push(val);
            DataManager.saveToLocal();
            inp.value = '';
            this.renderSubjectList();
        },

        editSubject: function(idx) {
            const oldName = GLOBAL_DATA.config.subjects[idx];
            const newName = prompt("Nh·∫≠p t√™n m·ªõi cho m√¥n thi:", oldName);
            if(newName && newName.trim() !== "" && newName !== oldName) {
                if(GLOBAL_DATA.config.subjects.includes(newName)) return alert("T√™n m√¥n n√†y ƒë√£ t·ªìn t·∫°i!");
                
                GLOBAL_DATA.config.subjects[idx] = newName;
                QUESTION_DB.forEach(q => {
                    if(q.subject === oldName) q.subject = newName;
                });
                
                DataManager.saveToLocal();
                this.renderSubjectList();
            }
        },

        removeSubject: function(idx) {
            if(confirm("X√≥a m√¥n n√†y?")) {
                GLOBAL_DATA.config.subjects.splice(idx, 1);
                DataManager.saveToLocal();
                this.renderSubjectList();
            }
        },

        rememberSubject: function() {
            const val = document.getElementById('user-subject-select').value;
            localStorage.setItem(DataManager.SUB_KEY, val);
        },

        changePassword: function() {
            const oldP = document.getElementById('old-pass').value;
            const newP = document.getElementById('new-pass').value;
            
            if(!oldP || !newP) return alert("Vui l√≤ng ƒëi·ªÅn ƒë·ªß th√¥ng tin!");
            
            const currentHash = GLOBAL_DATA.config.adminHash || Utils.sha256("123");
            if(Utils.sha256(oldP) !== currentHash) return alert("M·∫≠t kh·∫©u c≈© kh√¥ng ƒë√∫ng!");
            
            GLOBAL_DATA.config.adminHash = Utils.sha256(newP);
            DataManager.saveToLocal();
            alert("ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng!");
            document.getElementById('old-pass').value = "";
            document.getElementById('new-pass').value = "";
        },

        openModal: function(index = -1) {
            const modal = document.getElementById('editor-modal');
            const container = document.getElementById('options-container');
            document.getElementById('edit-index').value = index;
            container.innerHTML = ''; 
            this.clearImage(false);

            if (index === -1) { 
                document.getElementById('modal-title').innerText = "Th√™m c√¢u h·ªèi m·ªõi";
                document.getElementById('inp-question').value = "";
                document.getElementById('inp-math').value = "";
                document.getElementById('inp-code').value = "";
                document.getElementById('inp-code-lang').value = "plaintext";
                document.getElementById('inp-note').value = "";
                document.getElementById('inp-type').value = "single";
                const filterVal = document.getElementById('admin-filter-subject').value;
                if(filterVal !== 'ALL') document.getElementById('inp-subject').value = filterVal;
                
                for(let i=0; i<4; i++) this.addOptionUI('', false);
            } else { 
                const q = QUESTION_DB[index];
                document.getElementById('modal-title').innerText = "S·ª≠a c√¢u h·ªèi #" + (index + 1);
                document.getElementById('inp-subject').value = q.subject || GLOBAL_DATA.config.subjects[0];
                document.getElementById('inp-question').value = q.question;
                if(q.image) {
                    document.getElementById('inp-image-data').value = q.image;
                    const img = document.getElementById('img-preview');
                    img.src = q.image;
                    img.style.display = 'block';
                    document.getElementById('btn-clear-img').style.display = 'inline-block';
                }
                document.getElementById('inp-math').value = q.math || "";
                document.getElementById('inp-code').value = q.code || "";
                document.getElementById('inp-code-lang').value = q.lang || "plaintext";
                document.getElementById('inp-note').value = q.note || "";
                const isMulti = Array.isArray(q.answer);
                document.getElementById('inp-type').value = isMulti ? 'multi' : 'single';
                q.options.forEach((optText, i) => {
                    let isCorrect = isMulti ? q.answer.includes(i) : q.answer === i;
                    this.addOptionUI(optText, isCorrect);
                });
            }
            modal.classList.add('active');
        },

        initImageHandlers: function() {
            const pasteArea = document.getElementById('paste-area');
            pasteArea.addEventListener('click', () => document.getElementById('inp-file-hidden').click());
            pasteArea.addEventListener('dragover', (e) => { e.preventDefault(); pasteArea.classList.add('dragover'); });
            pasteArea.addEventListener('dragleave', () => pasteArea.classList.remove('dragover'));
            pasteArea.addEventListener('drop', (e) => {
                e.preventDefault(); pasteArea.classList.remove('dragover');
                if (e.dataTransfer.files && e.dataTransfer.files[0]) this.processImageFile(e.dataTransfer.files[0]);
            });
            document.addEventListener('paste', (e) => {
                if (!document.getElementById('editor-modal').classList.contains('active')) return;
                if (e.clipboardData && e.clipboardData.items) {
                    for (let i = 0; i < e.clipboardData.items.length; i++) {
                        if (e.clipboardData.items[i].type.indexOf("image") !== -1) {
                            this.processImageFile(e.clipboardData.items[i].getAsFile());
                            break;
                        }
                    }
                }
            });
        },

        handleFileSelect: function(input) {
            if (input.files && input.files[0]) this.processImageFile(input.files[0]);
        },

        processImageFile: function(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('inp-image-data').value = e.target.result;
                const img = document.getElementById('img-preview');
                img.src = e.target.result;
                img.style.display = 'block';
                document.getElementById('btn-clear-img').style.display = 'inline-block';
            };
            reader.readAsDataURL(file);
        },

        clearImage: function(clearInput = true) {
            if(clearInput) document.getElementById('inp-image-data').value = "";
            document.getElementById('img-preview').style.display = "none";
            document.getElementById('img-preview').src = "";
            document.getElementById('btn-clear-img').style.display = "none";
            document.getElementById('inp-file-hidden').value = "";
        },

        closeModal: function() { document.getElementById('editor-modal').classList.remove('active'); },

        addOptionUI: function(text = '', isChecked = false) {
            const container = document.getElementById('options-container');
            const type = document.getElementById('inp-type').value; 
            const inputType = (type === 'single') ? 'radio' : 'checkbox';
            const div = document.createElement('div');
            div.className = 'option-row';
            div.innerHTML = `
                <input type="${inputType}" name="correct_ans_selector" class="option-check" ${isChecked ? 'checked' : ''}>
                <input type="text" class="form-control option-text" value="${Utils.escapeHtml(text)}" placeholder="Nh·∫≠p ƒë√°p √°n...">
                <button type="button" class="btn-remove-opt" onclick="this.parentElement.remove()">√ó</button>
            `;
            container.appendChild(div);
        },

        changeType: function() {
            const type = document.getElementById('inp-type').value;
            const inputType = (type === 'single') ? 'radio' : 'checkbox';
            document.querySelectorAll('input[name="correct_ans_selector"]').forEach(inp => {
                inp.type = inputType;
                inp.checked = false; 
            });
        },

        saveQuestion: function() {
            const qText = document.getElementById('inp-question').value.trim();
            const qImage = document.getElementById('inp-image-data').value.trim();
            const qMath = document.getElementById('inp-math').value.trim();
            const qCode = document.getElementById('inp-code').value.trim();
            const qLang = document.getElementById('inp-code-lang').value;
            const qNote = document.getElementById('inp-note').value.trim();
            const qSub = document.getElementById('inp-subject').value;
            const qType = document.getElementById('inp-type').value;
            const index = parseInt(document.getElementById('edit-index').value);

            const optRows = document.querySelectorAll('.option-row');
            let optionsArr = [];
            let correctIndices = [];

            optRows.forEach((row, i) => {
                const text = row.querySelector('.option-text').value.trim();
                const isChecked = row.querySelector('.option-check').checked;
                if (text) {
                    optionsArr.push(text);
                    if (isChecked) correctIndices.push(optionsArr.length - 1);
                }
            });

            if (!qText) return alert("Vui l√≤ng nh·∫≠p n·ªôi dung!");
            if (optionsArr.length < 2) return alert("C·∫ßn √≠t nh·∫•t 2 ƒë√°p √°n!");
            if (correctIndices.length === 0) return alert("Ch·ªçn √≠t nh·∫•t 1 ƒë√°p √°n ƒë√∫ng!");
            if (qType === 'single' && correctIndices.length > 1) return alert("Ch·∫ø ƒë·ªô 'Ch·ªçn 1' ch·ªâ ƒë∆∞·ª£c ph√©p c√≥ 1 ƒë√°p √°n ƒë√∫ng!");

            let finalAnswer = (qType === 'single') ? correctIndices[0] : correctIndices;

            const newQuestion = {
                question: qText, image: qImage || null, math: qMath || null,
                code: qCode || null, lang: qLang || 'plaintext',
                options: optionsArr, answer: finalAnswer, note: qNote, subject: qSub
            };

            if (index === -1) QUESTION_DB.push(newQuestion);
            else QUESTION_DB[index] = newQuestion;

            DataManager.saveToLocal();
            this.closeModal();
        },

        toggleTimeInput: function() {
            const isUnlimited = document.getElementById('unlimited-time').checked;
            const timeInput = document.getElementById('quiz-duration');
            timeInput.disabled = isUnlimited;
            if (isUnlimited) timeInput.style.opacity = "0.5";
            else { timeInput.style.opacity = "1"; timeInput.focus(); }
        }
    };

    // ==========================================
    // QUIZ APP
    // ==========================================
    const QuizApp = {
        currentData: [],
        timerInterval: null,
        currentPlayerName: '',
        currentSubject: '',
        
        updateSubjectInfo: function() {
            const sel = document.getElementById('user-subject-select').value;
            let count = 0;
            if(sel === 'ALL') count = QUESTION_DB.length;
            else count = QUESTION_DB.filter(q => q.subject === sel).length;
            document.getElementById('subject-info-display').innerText = `T·ªïng s·ªë c√¢u h·ªèi: ${count}`;
        },

        start: function(isShuffle) {
            const nameInput = document.getElementById('student-name');
            const subjectSel = document.getElementById('user-subject-select').value;
            const nameVal = nameInput.value.trim();
            
            if (!nameVal) {
                alert("Vui l√≤ng nh·∫≠p t√™n c·ªßa b·∫°n!");
                nameInput.focus();
                return;
            }

            let dataToUse = [];
            if(subjectSel === 'ALL') dataToUse = [...QUESTION_DB];
            else dataToUse = QUESTION_DB.filter(q => q.subject === subjectSel);

            if(dataToUse.length === 0) return alert("M√¥n n√†y ch∆∞a c√≥ c√¢u h·ªèi n√†o!");

            this.currentPlayerName = nameVal;
            this.currentSubject = subjectSel;
            localStorage.setItem(DataManager.NAME_KEY, nameVal);
            
            const isUnlimited = document.getElementById('unlimited-time').checked;
            let durationMin = parseInt(document.getElementById('quiz-duration').value);
            if(isNaN(durationMin) || durationMin < 1) durationMin = 30;

            document.getElementById('start-screen').classList.remove('active');
            document.getElementById('quiz-screen').classList.add('active');
            document.getElementById('result-box').style.display = 'none'; 
            document.getElementById('submit-btn').style.display = 'block';
            
            document.getElementById('display-student-name').innerText = this.currentPlayerName;
            document.getElementById('display-subject-name').innerText = (subjectSel === 'ALL') ? "T·∫§T C·∫¢ M√îN" : subjectSel;

            dataToUse = JSON.parse(JSON.stringify(dataToUse));
            if (isShuffle) {
                dataToUse.sort(() => Math.random() - 0.5);
                dataToUse = dataToUse.map(q => this.shuffleOptionsInQuestion(q));
            }
            this.currentData = dataToUse;
            
            this.render();
            this.startTimer(durationMin, isUnlimited);
            window.scrollTo(0, 0);
        },

        resetToHome: function() {
            if(this.timerInterval) clearInterval(this.timerInterval);
            document.getElementById('quiz-screen').classList.remove('active');
            document.getElementById('start-screen').classList.add('active');
            document.getElementById('timer-display').innerText = "‚àû";
            this.renderLeaderboard(); // from DataManager but context here
            DataManager.renderLeaderboard();
        },

        shuffleOptionsInQuestion: function(question) {
            let mappedOptions = question.options.map((opt, i) => ({ text: opt, oldIdx: i }));
            mappedOptions.sort(() => Math.random() - 0.5);
            question.options = mappedOptions.map(m => m.text);
            if (Array.isArray(question.answer)) {
                question.answer = question.answer.map(ansIdx => mappedOptions.findIndex(m => m.oldIdx === ansIdx)).sort((a,b) => a - b);
            } else {
                question.answer = mappedOptions.findIndex(m => m.oldIdx === question.answer);
            }
            return question;
        },

        render: function() {
            const container = document.getElementById('quiz-container');
            let html = '';
            this.currentData.forEach((q, index) => {
                let codeHtml = '';
                if (q.code) {
                    const langClass = q.lang ? `language-${q.lang}` : '';
                    codeHtml = `<div class="code-block"><span class="code-lang-badge">${q.lang ? q.lang.toUpperCase() : 'CODE'}</span><pre><code class="${langClass}">${Utils.escapeHtml(q.code)}</code></pre></div>`;
                }
                const mathHtml = q.math ? `<div class="math-block">${Utils.escapeHtml(q.math)}</div>` : '';
                const imgHtml = q.image ? `<img src="${q.image}" class="quiz-image" alt="H√¨nh ·∫£nh c√¢u h·ªèi">` : '';
                const isMulti = Array.isArray(q.answer);
                const inputType = isMulti ? 'checkbox' : 'radio';
                const hint = isMulti ? '<small style="color:var(--primary-color)">(Ch·ªçn nhi·ªÅu)</small>' : '';
                html += `
                <div class="question-card" id="card-${index}" data-type="${isMulti ? 'multi' : 'single'}">
                    <div class="question-title">
                        C√¢u ${index + 1}: ${Utils.escapeHtml(q.question)} ${hint}
                    </div>
                    ${imgHtml} ${mathHtml} ${codeHtml}
                    <div>
                        ${q.options.map((opt, i) => `
                            <label class="option-label" onclick="QuizApp.selectOption(${index}, this)">
                                <input type="${inputType}" name="q-${index}" value="${i}" style="pointer-events:none;">
                                <span>${Utils.escapeHtml(opt)}</span>
                            </label>`).join('')}
                    </div>
                    <div class="explanation">
                        <strong>ƒê√°p √°n:</strong> 
                        ${isMulti ? q.answer.map(a => q.options[a]).join(', ') : q.options[q.answer]} <br>
                        <em>${q.note || ''}</em>
                    </div>
                </div>`;
            });
            container.innerHTML = html;
            document.querySelectorAll('pre code').forEach((block) => hljs.highlightElement(block));
            if(window.MathJax) MathJax.typesetPromise();
        },

        selectOption: function(qIdx, label) {
            const card = document.getElementById(`card-${qIdx}`);
            const input = label.querySelector('input');
            const isMulti = card.dataset.type === 'multi';
            if(input.disabled) return; 
            if (isMulti) {
                input.checked = !input.checked;
                label.classList.toggle('checked', input.checked);
            } else {
                card.querySelectorAll('.option-label').forEach(l => {
                    l.classList.remove('checked');
                    l.querySelector('input').checked = false;
                });
                label.classList.add('checked');
                input.checked = true;
            }
        },

        startTimer: function(minutes, isUnlimited) {
            const display = document.getElementById('timer-display');
            if(this.timerInterval) clearInterval(this.timerInterval);
            if (isUnlimited) {
                display.innerText = "‚àû"; 
                display.classList.remove('timer-warning');
                return;
            }
            let timeLeft = minutes * 60;
            this.updateTimerDisplay(timeLeft, display);
            this.timerInterval = setInterval(() => {
                timeLeft--;
                this.updateTimerDisplay(timeLeft, display);
                if (timeLeft <= 0) {
                    clearInterval(this.timerInterval);
                    alert("ƒê√£ h·∫øt th·ªùi gian l√†m b√†i!");
                    this.submit();
                }
            }, 1000);
        },

        updateTimerDisplay: function(seconds, displayElement) {
            const m = Math.floor(seconds / 60);
            const s = seconds % 60;
            displayElement.innerText = `${m < 10 ? '0'+m : m}:${s < 10 ? '0'+s : s}`;
            if(seconds < 60) displayElement.classList.add('timer-warning');
            else displayElement.classList.remove('timer-warning');
        },

        submit: function() {
            if(this.timerInterval) clearInterval(this.timerInterval);
            let score = 0;
            this.currentData.forEach((q, idx) => {
                const card = document.getElementById(`card-${idx}`);
                const inputs = card.querySelectorAll('input');
                const labels = card.querySelectorAll('.option-label');
                const isMulti = Array.isArray(q.answer);
                let userAns = [];
                inputs.forEach((inp, i) => {
                    if(inp.checked) userAns.push(i);
                    inp.disabled = true; 
                });
                let isCorrect = false;
                if(isMulti) {
                    if(userAns.length === q.answer.length && userAns.every(v => q.answer.includes(v))) isCorrect = true;
                    labels.forEach((lbl, i) => {
                        if(q.answer.includes(i)) lbl.classList.add('correct'); 
                        if(userAns.includes(i) && !q.answer.includes(i)) lbl.classList.add('incorrect'); 
                    });
                } else {
                    if(userAns.length > 0 && userAns[0] === q.answer) isCorrect = true;
                    labels[q.answer].classList.add('correct');
                    if(!isCorrect && userAns.length > 0) labels[userAns[0]].classList.add('incorrect');
                }
                if(isCorrect) score++;
                card.querySelector('.explanation').style.display = 'block';
            });

            const finalScore = parseFloat((score / this.currentData.length * 10).toFixed(1));

            const date = new Date();
            const dateStr = `${date.getDate()}/${date.getMonth()+1} ${date.getHours()}:${date.getMinutes()}`;
            
            const newEntry = {
                name: this.currentPlayerName,
                score: finalScore,
                correct: score, 
                total: this.currentData.length,
                date: dateStr,
                subject: (this.currentSubject === 'ALL') ? "T·∫•t c·∫£ m√¥n" : this.currentSubject
            };

            GLOBAL_DATA.leaderboard.unshift(newEntry);
            
            if (GLOBAL_DATA.leaderboard.length > 100) GLOBAL_DATA.leaderboard = GLOBAL_DATA.leaderboard.slice(0, 100);

            DataManager.saveToLocal();

            document.getElementById('submit-btn').style.display = 'none';
            const rBox = document.getElementById('result-box');
            rBox.style.display = 'block';
            document.getElementById('correct-count').innerText = score;
            document.getElementById('total-count').innerText = this.currentData.length;
            document.getElementById('final-score').innerText = finalScore;
            rBox.scrollIntoView({behavior: 'smooth'});
        }
    };

    DataManager.init();
    Manager.initImageHandlers(); 

    document.addEventListener('keydown', function(event) {
        if (event.key === "Escape") {
            if (document.getElementById('editor-modal').classList.contains('active')) Manager.closeModal();
        }
    });

// ============================================================
// B·ªî SUNG T√çNH NƒÇNG JSON & GOOGLE SHEET
// ============================================================

// 1. H√†m Xu·∫•t to√†n b·ªô d·ªØ li·ªáu ra JSON
DataManager.exportJSON = function() {
    const fullData = {
        meta: "TestTracNghiemPro_Backup",
        date: new Date().toLocaleString(),
        questions: GLOBAL_DATA.questions,
        subjects: GLOBAL_DATA.subjects,
        leaderboard: GLOBAL_DATA.leaderboard
    };
    
    const dataStr = JSON.stringify(fullData, null, 2);
    const blob = new Blob([dataStr], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = "database_tracnghiem_" + new Date().toISOString().slice(0,10) + ".json";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
};

// 2. H√†m Nh·∫≠p file JSON t·ª´ m√°y t√≠nh
DataManager.importJSONFile = function(inputElement) {
    const file = inputElement.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            DataManager.mergeData(data);
        } catch (err) {
            alert("L·ªói ƒë·ªçc file JSON: " + err);
        }
        inputElement.value = ''; // Reset input
    };
    reader.readAsText(file);
};

// 3. H√†m T·∫£i d·ªØ li·ªáu t·ª´ Link (Google Apps Script / Raw JSON)
DataManager.loadFromCloud = function() {
    const url = document.getElementById('cloud-url').value.trim();
    if (!url) {
        alert("Vui l√≤ng nh·∫≠p ƒë∆∞·ªùng d·∫´n URL!");
        return;
    }

    const btn = event.target;
    const oldText = btn.innerText;
    btn.innerText = "ƒêang t·∫£i...";
    btn.disabled = true;

    fetch(url)
        .then(response => {
            if (!response.ok) throw new Error("HTTP " + response.status);
            return response.json();
        })
        .then(data => {
            DataManager.mergeData(data);
            alert("‚úÖ ƒê√£ c·∫≠p nh·∫≠t d·ªØ li·ªáu th√†nh c√¥ng t·ª´ Cloud!");
        })
        .catch(err => {
            console.error(err);
            alert("‚ùå Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu.\nL·ªói: " + err.message + "\n\nL∆∞u √Ω: N·∫øu link Google Sheet, h√£y ƒë·∫£m b·∫£o b·∫°n ƒë√£ Deploy Web App v√† set quy·ªÅn 'Anyone'.");
        })
        .finally(() => {
            btn.innerText = oldText;
            btn.disabled = false;
        });
};

// 4. H√†m x·ª≠ l√Ω tr·ªôn d·ªØ li·ªáu (D√πng chung cho c·∫£ 2 c√°ch tr√™n)
DataManager.mergeData = function(data) {
    if (!data.questions && !data.subjects) {
        alert("File JSON kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng database c·ªßa App!");
        return;
    }

    if (confirm("B·∫°n c√≥ mu·ªën ghi ƒë√® to√†n b·ªô d·ªØ li·ªáu hi·ªán t·∫°i b·∫±ng d·ªØ li·ªáu m·ªõi kh√¥ng?\n(Ch·ªçn Cancel ƒë·ªÉ gi·ªØ d·ªØ li·ªáu c≈© v√† g·ªôp th√™m)")) {
        // Ghi ƒë√®
        if (data.questions) GLOBAL_DATA.questions = data.questions;
        if (data.subjects) GLOBAL_DATA.subjects = data.subjects;
        if (data.leaderboard) GLOBAL_DATA.leaderboard = data.leaderboard;
    } else {
        // G·ªôp th√™m (ƒë∆°n gi·∫£n l√† n·ªëi m·∫£ng, c·∫ßn c·∫©n th·∫≠n tr√πng l·∫∑p ID n·∫øu c√≥ c∆° ch·∫ø ID)
        // ·ªû code c≈© c·ªßa b·∫°n d√πng index m·∫£ng, n√™n g·ªôp v√†o cu·ªëi l√† an to√†n nh·∫•t.
        if (data.questions) GLOBAL_DATA.questions = GLOBAL_DATA.questions.concat(data.questions);
        if (data.leaderboard) GLOBAL_DATA.leaderboard = GLOBAL_DATA.leaderboard.concat(data.leaderboard);
        // Subject th√¨ n√™n l·ªçc tr√πng
        if (data.subjects) {
            data.subjects.forEach(s => {
                if (!GLOBAL_DATA.subjects.includes(s)) GLOBAL_DATA.subjects.push(s);
            });
        }
    }

    DataManager.saveToLocal();
    Manager.renderList(); // Render l·∫°i giao di·ªán Admin
    // C·∫≠p nh·∫≠t l·∫°i list subject ·ªü m√†n h√¨nh start
    const subjSelect = document.getElementById('user-subject-select');
    // ... logic render l·∫°i select option n·∫øu c·∫ßn thi·∫øt (th∆∞·ªùng reload trang l√† nhanh nh·∫•t)
    location.reload(); 
};

</script>
</body></html>